name: Build the executables

on: workflow_dispatch

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v2

      - name: Set app configuration
        env:
          APP_NAME: inky-plus
          DESCRIPTION: "An editor for ink: inkle's narrative scripting language"

          # This must be of the format "N.N.N", where the N's are all numbers
          VERSION: 1.0.0

          # By default, the author will be your name on GitHub. You can manually change this.
          AUTHOR: "inkle ltd."

        run: |
          echo "APP_NAME=${APP_NAME}" >> $GITHUB_ENV
          echo "DESCRIPTION=${DESCRIPTION}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "AUTHOR=${AUTHOR}" >> $GITHUB_ENV

      - name: Install Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 20

      - name: Create icon from PNG
        run: ./resources/makeIcns.command

      - name: Set up Electron app environment
        working-directory: ./app
        run: npm install

      # insures that the index.html has been built
      - name: Build electron app (Win)
        if: matrix.os == 'windows-latest'
        run: |
          npx --yes @electron/packager app "Inky Plus" --platform=win32  --arch=x64 --icon=./resources/Icon1024.png.ico --prune --asar.unpackDir="main-process/ink" --ignore="inklecate_mac" --win32metadata.ProductName="Inky Plus" --win32metadata.CompanyName="inkle Ltd" --win32metadata.FileDescription="Inky Plus" --win32metadata.OriginalFilename="Inky Plus" --win32metadata.InternalName="Inky Plus"
          mkdir -p ReleaseUpload
          tar -czf Inky-Plus-win32-x64.tar.gz "Inky Plus-win32-x64"
          mv Inky-Plus-win32-x64.tar.gz ReleaseUpload/Inky-Plus-win32-x64.tar.gz

      
      - name: Build electron app (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          npx --yes @electron/packager app "Inky Plus" --platform=linux --arch=x64 --icon=./resources/Icon.icns --extend-info=resources/info.plist --prune --asar.unpackDir="main-process/ink" --ignore="inklecate_mac"
          mkdir -p ReleaseUpload
          zip -r ReleaseUpload/Inky_Plus_linux.zip "Inky Plus-linux-x64"


      # If there is no passed-in tag, we auto-generate one based on run number
      # This makes sure a different process (e.g. a Windows build vs Mac build) hasn't created it
      - name: Check if auto-generated tag exists
        uses: actions/github-script@v4
        id: autogeneratedTagExists
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            try {
              const result = await github.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/v${context.runNumber}.0.0`
              })
              console.log("Found!")
              console.log(result)
              return true
            } catch(e) {
              console.log("Failed", e)
              return false
            }

      # TODO: The previous GH script should just create the tag if needed
      - name: Create tag if needed
        uses: negz/create-tag@v1
        if: ${{ !steps.autogeneratedTagExists.outputs.result && !startsWith(github.ref, 'refs/tags/v') }}
        with:
          version: ${{ format('v{0}.0.0', github.run_number) }}
          message: Auto-generated by GitHub Actions
          token: ${{ secrets.GITHUB_TOKEN }}

      # The next two steps are identical, except for explicitly passing in the tag name in the latter
      # I wish I knew how to do this in a more elegant way.
      # See also: I'd love to abstract out the startsWith() check and generated tag name into variable
      
      - name: Release on GitHub (Built via Tag)
        uses: softprops/action-gh-release@v1
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ReleaseUpload/**/*.zip
            
      
      - name: Release on GitHub (Automated Tag)
        uses: softprops/action-gh-release@v1
        if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ format('v{0}.0.0', github.run_number) }}
          files: |
            ReleaseUpload/**/*.zip
            